#!/bin/bash

# =============================================
# Ð”ÐµÐ¿Ð»Ð¾Ð¹ TaskMaster API Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
# Ð’ÐµÑ€ÑÐ¸Ñ: 1.0
# =============================================

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
set -e  # ÐŸÑ€ÐµÑ€Ñ‹Ð²Ð°Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
PROJECT_NAME="taskmaster-api"
PROJECT_DIR="/var/www/taskmaster"
REPO_URL="https://github.com/VladimirKraswov/TaskMaster-backend.git"
BRANCH="main"  # Ð¸Ð»Ð¸ master, Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð²Ð°ÑˆÐµÐ³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
check_permissions() {
    log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ..."
    if [[ $EUID -eq 0 ]]; then
        log_warning "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¾Ñ‚ root. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ sudo."
        read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ? (y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "ÐŸÑ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ..."
            exit 1
        fi
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
check_dependencies() {
    log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    
    local missing_deps=()
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Node.js
    if ! command -v node &> /dev/null; then
        missing_deps+=("Node.js")
    else
        NODE_VERSION=$(node -v | cut -d'v' -f2)
        log_info "Node.js Ð²ÐµÑ€ÑÐ¸Ð¸ $NODE_VERSION Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð°"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° npm
    if ! command -v npm &> /dev/null; then
        missing_deps+=("npm")
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° PM2
    if ! command -v pm2 &> /dev/null; then
        missing_deps+=("PM2")
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Git
    if ! command -v git &> /dev/null; then
        missing_deps+=("Git")
    fi
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        log_error "ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸: ${missing_deps[*]}"
        
        # ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        if [ -f /etc/debian_version ]; then
            log_info "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Debian/Ubuntu ÑÐ¸ÑÑ‚ÐµÐ¼Ð°"
            read -p "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸? (y/n): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                install_dependencies_debian
            else
                exit 1
            fi
        else
            log_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:"
            for dep in "${missing_deps[@]}"; do
                echo "  - $dep"
            done
            exit 1
        fi
    else
        log_success "Ð’ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
    fi
}

install_dependencies_debian() {
    log_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ Debian/Ubuntu..."
    sudo apt update
    sudo apt install -y curl git
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js (ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°)
    if ! command -v node &> /dev/null; then
        log_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js..."
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt install -y nodejs
    fi
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2
    if ! command -v pm2 &> /dev/null; then
        log_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2..."
        sudo npm install -g pm2
    fi
    
    log_success "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
create_project_structure() {
    log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
    if [ ! -d "$PROJECT_DIR" ]; then
        log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°: $PROJECT_DIR"
        sudo mkdir -p "$PROJECT_DIR"
        sudo chown -R $USER:$USER "$PROJECT_DIR"
    else
        log_info "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚: $PROJECT_DIR"
    fi
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
    LOG_DIR="/var/log/$PROJECT_NAME"
    if [ ! -d "$LOG_DIR" ]; then
        log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð»Ð¾Ð³Ð¾Ð²: $LOG_DIR"
        sudo mkdir -p "$LOG_DIR"
        sudo chown -R $USER:$USER "$LOG_DIR"
    fi
}

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
clone_or_update_repo() {
    log_info "Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ¼..."
    
    cd "$PROJECT_DIR"
    
    if [ ! -d ".git" ]; then
        log_info "ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
        git clone "$REPO_URL" .
    else
        log_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
        git fetch origin
        git checkout "$BRANCH"
        git pull origin "$BRANCH"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸
    if [ $? -ne 0 ]; then
        log_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ¼"
        exit 1
    fi
    
    log_success "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
setup_environment() {
    log_info "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
    
    cd "$PROJECT_DIR"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ .env
    if [ ! -f ".env" ]; then
        log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° .env Ð¸Ð· Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ production
        cat > .env << EOF
# === ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ===
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# === Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ ===
# Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ðµ ÐºÐ»ÑŽÑ‡Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹:
# node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
ACCESS_SECRET=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")
REFRESH_SECRET=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")

# === Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… SQLite ===
DATABASE_URL=$PROJECT_DIR/prod.sqlite3

# === Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ===
LOG_LEVEL=info
EOF
        
        log_warning "Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» .env. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐµÐ³Ð¾ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸!"
        log_info "Ð¤Ð°Ð¹Ð» .env Ñ€Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½ Ð²: $PROJECT_DIR/.env"
        
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
        echo ""
        log_info "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ .env Ñ„Ð°Ð¹Ð»Ð°:"
        echo "========================================"
        cat .env
        echo "========================================"
        echo ""
        
        read -p "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ..."
    else
        log_info "Ð¤Ð°Ð¹Ð» .env ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    fi
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° .env
    chmod 600 .env
}

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
install_project_dependencies() {
    log_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
    
    cd "$PROJECT_DIR"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ package.json
    if [ ! -f "package.json" ]; then
        log_error "Ð¤Ð°Ð¹Ð» package.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
        exit 1
    fi
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
    log_info "Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ npm install --production..."
    npm install --production
    
    if [ $? -ne 0 ]; then
        log_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ npm"
        exit 1
    fi
    
    log_success "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
}

# Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
run_migrations() {
    log_info "Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
    
    cd "$PROJECT_DIR"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ knexfile.js
    if [ ! -f "knexfile.js" ]; then
        log_error "Ð¤Ð°Ð¹Ð» knexfile.js Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
        exit 1
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
    if [ ! -d "migrations" ]; then
        log_warning "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ migrations Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸."
        return 0
    fi
    
    # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
    log_info "Ð—Ð°Ð¿ÑƒÑÐº Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð´Ð»Ñ production..."
    NODE_ENV=production npx knex migrate:latest
    
    if [ $? -ne 0 ]; then
        log_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹"
        exit 1
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, ÑÐ¾Ð·Ð´Ð°Ð»ÑÑ Ð»Ð¸ Ñ„Ð°Ð¹Ð» Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    if [ -f "prod.sqlite3" ]; then
        log_info "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° Ñ„Ð°Ð¹Ð» Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
        chmod 644 prod.sqlite3
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸ Ð‘Ð”
        if command -v sqlite3 &> /dev/null; then
            log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
            if sqlite3 prod.sqlite3 "PRAGMA integrity_check;" | grep -q "ok"; then
                log_success "Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾ÑˆÐ»Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸"
            else
                log_warning "ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸ Ð‘Ð”"
            fi
        fi
    fi
    
    log_success "ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº PM2
setup_pm2() {
    log_info "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PM2..."
    
    cd "$PROJECT_DIR"
    
    # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
    if pm2 list | grep -q "$PROJECT_NAME"; then
        log_info "ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° $PROJECT_NAME..."
        pm2 stop "$PROJECT_NAME"
        pm2 delete "$PROJECT_NAME"
    fi
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ecosystem Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ PM2
    log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ PM2..."
    
    cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: '$PROJECT_NAME',
    script: 'src/server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '500M',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/var/log/$PROJECT_NAME/error.log',
    out_file: '/var/log/$PROJECT_NAME/out.log',
    log_file: '/var/log/$PROJECT_NAME/combined.log',
    time: true,
    env_production: {
      NODE_ENV: 'production'
    }
  }]
};
EOF
    
    # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· PM2
    log_info "Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ PM2..."
    pm2 start ecosystem.config.js --env production
    
    if [ $? -ne 0 ]; then
        log_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ PM2"
        exit 1
    fi
    
    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
    log_info "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ° PM2..."
    pm2 save
    AUTO_START_CMD=$(pm2 startup | tail -n 1)
    
    if [ ! -z "$AUTO_START_CMD" ]; then
        log_info "Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°: $AUTO_START_CMD"
        eval "$AUTO_START_CMD"
    fi
    
    log_success "PM2 Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
health_check() {
    log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
    
    local max_attempts=10
    local attempt=1
    local wait_time=3
    
    log_info "ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
    
    while [ $attempt -le $max_attempts ]; do
        log_info "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° $attempt Ð¸Ð· $max_attempts..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· curl
        if curl -s -f "http://localhost:3000/health" > /dev/null; then
            log_success "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð¸ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚!"
            
            # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° API
            echo ""
            log_info "Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° API:"
            echo "========================================"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° health endpoint
            HEALTH_RESPONSE=$(curl -s http://localhost:3000/health)
            echo "Health endpoint: $HEALTH_RESPONSE"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ endpoint
            ROOT_RESPONSE=$(curl -s http://localhost:3000/)
            echo "Root endpoint: $ROOT_RESPONSE"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° PM2 ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
            echo ""
            log_info "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ PM2:"
            pm2 list | grep "$PROJECT_NAME"
            
            echo "========================================"
            return 0
        fi
        
        sleep $wait_time
        attempt=$((attempt + 1))
    done
    
    log_error "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¾ÑÑŒ Ð¿Ð¾ÑÐ»Ðµ $max_attempts Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº"
    
    # ÐŸÐ¾ÐºÐ°Ð· Ð»Ð¾Ð³Ð¾Ð² Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
    echo ""
    log_info "ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:"
    pm2 logs "$PROJECT_NAME" --lines 20
    
    return 1
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
create_management_scripts() {
    log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ..."
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°
    cat > "$PROJECT_DIR/restart.sh" << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
pm2 restart taskmaster-api
echo "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾"
EOF
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð»Ð¾Ð³Ð¾Ð²
    cat > "$PROJECT_DIR/logs.sh" << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
pm2 logs taskmaster-api
EOF
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
    cat > "$PROJECT_DIR/update.sh" << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
git pull origin main
echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
npm install --production
echo "Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹..."
NODE_ENV=production npx knex migrate:latest
echo "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
pm2 restart taskmaster-api
echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾"
EOF
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð²
    chmod +x "$PROJECT_DIR/restart.sh"
    chmod +x "$PROJECT_DIR/logs.sh"
    chmod +x "$PROJECT_DIR/update.sh"
    
    log_success "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹:"
    log_info "  restart.sh - Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
    log_info "  logs.sh    - Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²"
    log_info "  update.sh  - Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    echo ""
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        Ð”ÐµÐ¿Ð»Ð¾Ð¹ TaskMaster API          ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
    
    # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑˆÐ°Ð³Ð¾Ð²
    check_permissions
    check_dependencies
    create_project_structure
    clone_or_update_repo
    setup_environment
    install_project_dependencies
    run_migrations
    setup_pm2
    health_check
    create_management_scripts
    
    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}       Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!        ${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    
    # Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ
    echo "ðŸ“‹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ:"
    echo "   ÐŸÑ€Ð¾ÐµÐºÑ‚: $PROJECT_NAME"
    echo "   Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $PROJECT_DIR"
    echo "   URL API: http://localhost:3000"
    echo "   Ð›Ð¾Ð³Ð¸: /var/log/$PROJECT_NAME/"
    echo ""
    echo "ðŸ› ï¸  ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:"
    echo "   cd $PROJECT_DIR"
    echo "   ./restart.sh  # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
    echo "   ./logs.sh     # ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²"
    echo "   ./update.sh   # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ"
    echo ""
    echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ PM2:"
    pm2 list | grep "$PROJECT_NAME"
    echo ""
    echo "ðŸŒ Ð”Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Nginx Proxy Manager:"
    echo "   - Ð”Ð¾Ð¼ÐµÐ½: task-master.fast-go.ru"
    echo "   - IP: 127.0.0.1"
    echo "   - ÐŸÐ¾Ñ€Ñ‚: 3000"
    echo ""
}

# Ð—Ð°Ð¿ÑƒÑÐº Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
main "$@"